<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>ê¸°ì‚¬ ì „ìš© ë°°ë‹¬ ì§€ë„ (ì¿ íŒ¡ í”Œë ‰ìŠ¤ ìŠ¤íƒ€ì¼)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- NAVER ì§€ë„ -->
    <script
      type="text/javascript"
      src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=ms2yp98bvf&submodules=geocoder"
    ></script>

    <!-- Excel ì½ê¸° -->
    <script src="https://unpkg.com/read-excel-file@5.7.1/bundle/read-excel-file.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f3f4f6;
        color: #111827;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 8px 12px;
        background: #111827;
        color: #f9fafb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
      }
      header .title-left {
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 700;
      }
      header .file-name {
        font-size: 11px;
        color: #e5e7eb;
        max-width: 50%;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        text-align: right;
      }

      #app {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }

      /* ìƒë‹¨ ì§€ë„, í•˜ë‹¨ ë¦¬ìŠ¤íŠ¸ ë¶„í•  (ì¿ íŒ¡ í”Œë ‰ìŠ¤ ë¹„ìŠ·í•œ êµ¬ì¡°) */
      #map-wrapper {
        position: relative;
        flex: 1 1 auto;
        min-height: 40%;
      }
      #map {
        width: 100%;
        height: 100%;
      }

      #list-wrapper {
        flex: 1 1 auto;
        min-height: 45%;
        max-height: 60%;
        background: #ffffff;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -4px 12px rgba(15, 23, 42, 0.25);
        display: flex;
        flex-direction: column;
      }

      #list-handle {
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: ns-resize;
      }
      #list-handle::after {
        content: "";
        width: 42px;
        height: 4px;
        border-radius: 999px;
        background: #d1d5db;
      }

      #list-header {
        padding: 4px 14px 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: #4b5563;
        border-bottom: 1px solid #e5e7eb;
      }
      #summary-counts {
        display: flex;
        gap: 8px;
      }
      #summary-counts span {
        background: #f3f4f6;
        padding: 3px 6px;
        border-radius: 999px;
      }

      #list {
        flex: 1 1 auto;
        overflow-y: auto;
        padding: 6px 10px 10px;
        background: #f9fafb;
      }

      .house-card {
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 10px 10px 8px;
        margin-bottom: 8px;
        display: grid;
        gap: 4px;
        font-size: 12px;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.1);
        cursor: pointer;
      }
      .house-card.active {
        border-color: #2563eb;
        box-shadow: 0 0 0 1px #2563eb;
      }

      .house-top-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 6px;
      }
      .house-main-title {
        font-weight: 700;
        font-size: 13px;
      }
      .house-main-badge {
        font-size: 11px;
        background: #eff6ff;
        color: #1d4ed8;
        padding: 2px 6px;
        border-radius: 999px;
      }

      .house-sub-line {
        font-size: 11px;
        color: #4b5563;
      }

      .house-addr {
        font-size: 11px;
        color: #374151;
      }

      .house-memo {
        margin-top: 2px;
        padding: 6px 8px;
        font-size: 11px;
        color: #b91c1c;
        background: #fef2f2;
        border-radius: 6px;
        line-height: 1.4;
      }

      .icon-row {
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .icon-btn {
        border: 0;
        border-radius: 999px;
        padding: 4px 8px;
        font-size: 11px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: #f3f4f6;
        color: #111827;
        cursor: pointer;
      }
      .icon-btn span {
        font-size: 13px;
      }
      .icon-btn.primary {
        background: #2563eb;
        color: #ffffff;
      }
      .icon-btn.warn {
        background: #fee2e2;
        color: #b91c1c;
      }
      .icon-btn.disabled {
        opacity: 0.4;
        cursor: default;
      }

      .parts-list {
        margin-top: 6px;
        border-top: 1px dashed #e5e7eb;
        padding-top: 4px;
        font-size: 11px;
      }
      .parts-list-title {
        font-weight: 600;
        color: #4b5563;
        margin-bottom: 2px;
      }
      .parts-list ul {
        padding-left: 16px;
        margin: 0;
      }
      .parts-list li {
        margin-bottom: 1px;
      }

      footer {
        padding: 6px 10px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-top: 1px solid #e5e7eb;
        background: #f9fafb;
      }
      label.upload-btn {
        background: #2563eb;
        color: #ffffff;
        border-radius: 999px;
        padding: 5px 10px;
        font-size: 11px;
        cursor: pointer;
      }
      #fileInput {
        display: none;
      }
      #log {
        color: #6b7280;
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* ë„¤ë¹„ê²Œì´ì…˜ ë°”í…€ì‹œíŠ¸ */
      #nav-sheet-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.35);
        display: none;
        z-index: 30;
      }
      #nav-sheet-overlay.open {
        display: block;
      }
      #nav-sheet {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: #ffffff;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -6px 20px rgba(15, 23, 42, 0.3);
        padding: 12px 16px 16px;
        transform: translateY(100%);
        transition: transform 0.2s ease-out;
        z-index: 40;
        font-size: 13px;
      }
      #nav-sheet.open {
        transform: translateY(0);
      }
      .nav-sheet-title {
        font-size: 15px;
        font-weight: 700;
        margin-bottom: 3px;
      }
      .nav-sheet-sub {
        font-size: 11px;
        color: #6b7280;
        margin-bottom: 8px;
      }
      .nav-sheet-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 6px;
      }
      .nav-sheet-buttons button {
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        padding: 8px 10px;
        font-size: 13px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        background: #f9fafb;
      }
      .nav-sheet-buttons button.primary {
        background: #2563eb;
        border-color: #2563eb;
        color: #ffffff;
      }
      #btn-nav-close {
        width: 100%;
        padding: 7px 0;
        font-size: 13px;
        border-radius: 10px;
        border: 0;
        background: #e5e7eb;
      }

      /* ë§ˆì»¤ìš© ê³µí†µ */
      .hidden {
        display: none !important;
      }

      @media (min-width: 769px) {
        /* PCì—ì„œë„ ì“¸ ìˆ˜ ìˆê²Œ ì¢Œìš° ë¶„í•  ì˜µì…˜ (í•„ìš”í•˜ë©´) */
        #app {
          flex-direction: row;
        }
        #map-wrapper {
          flex: 1.2;
        }
        #list-wrapper {
          flex: 1;
          max-height: none;
          border-radius: 0;
          box-shadow: none;
          border-left: 1px solid #e5e7eb;
        }
      }
    </style>
  </head>

  <body>
    <header>
      <div class="title-left">
        <span>ğŸšš</span>
        <span>ê¸°ì‚¬ ì „ìš© ë°°ì°¨ ë·° (ëª¨ë°”ì¼)</span>
      </div>
      <div id="fileName" class="file-name">ì—‘ì…€ì„ ì„ íƒí•˜ì„¸ìš”</div>
    </header>

    <div id="app">
      <div id="map-wrapper">
        <div id="map"></div>
      </div>

      <div id="list-wrapper">
        <div id="list-handle"></div>
        <div id="list-header">
          <div id="summary-counts">
            <span id="summary-houses">ê°€êµ¬ 0</span>
            <span id="summary-parts">í’ˆëª© 0</span>
            <span id="summary-cbm">CBM 0</span>
          </div>
          <div id="summary-extra"></div>
        </div>
        <div id="list"></div>
      </div>
    </div>

    <footer>
      <div style="display: flex; align-items: center; gap: 8px">
        <label for="fileInput" class="upload-btn">ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</label>
        <input id="fileInput" type="file" accept=".xlsx,.xls" />
        <span id="log"></span>
      </div>
      <div style="font-size: 10px; color: #6b7280">
        CBM 0ì¸ ì£¼ì†ŒëŠ” ìë™ ì œì™¸ Â· ë©”ëª¨ ìˆëŠ” ì§‘ì€ ë§ˆì»¤ ì£¼í™©ìƒ‰
      </div>
    </footer>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ ì„ íƒ ë°”í…€ì‹œíŠ¸ -->
    <div id="nav-sheet-overlay"></div>
    <div id="nav-sheet">
      <div class="nav-sheet-title">ë„¤ë¹„ê²Œì´ì…˜ ì„ íƒ</div>
      <div id="nav-sheet-dest" class="nav-sheet-sub">
        ëª©ì ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
      </div>
      <div class="nav-sheet-buttons">
        <button id="btn-nav-naver-route" class="primary">
          ğŸš— ë„¤ì´ë²„ ì§€ë„ ê¸¸ì°¾ê¸°
        </button>
        <button id="btn-nav-naver-place">ğŸ“ ë„¤ì´ë²„ ì§€ë„ ì¥ì†Œ í˜ì´ì§€</button>
        <button id="btn-nav-kakao">ğŸŸ¡ ì¹´ì¹´ì˜¤ë§µ ê¸¸ì°¾ê¸°</button>
        <button id="btn-nav-tmap">ğŸ”µ í‹°ë§µ ê¸¸ì°¾ê¸°</button>
      </div>
      <button id="btn-nav-close">ë‹«ê¸°</button>
    </div>

    <script>
      // ===== ì „ì—­ ìƒíƒœ =====
      const START_POINT_LAT = 37.158135; // ì¶œë°œì§€ (í‰íƒ ê¸°ì¤€ ì‚¬ìš© ì˜ˆì‹œ)
      const START_POINT_LNG = 127.103159;

      let map = null;
      let households = [];
      let markersById = new Map();
      let uiState = {
        focusedHouseholdId: null,
      };
      let navTarget = null;

      const COL_INDEX_FALLBACK = {
        addr: 13, // ì£¼ì†Œ
        phone: 11,
        cbm: 10,
        orderNo: 4, // 5ë²ˆì§¸ ì»¬ëŸ¼
        invoiceNo: 5, // 6ë²ˆì§¸ ì»¬ëŸ¼
        product: 9,
        vendor: 6,
        memoFixed: 18, // 19ë²ˆì§¸ ì»¬ëŸ¼ (0-based)
      };

      function logInfo(msg) {
        const el = document.getElementById("log");
        if (el) el.textContent = msg;
        console.log("[INFO]", msg);
      }
      function logError(msg, err) {
        const el = document.getElementById("log");
        if (el) el.textContent = "âš  " + msg;
        console.error("[ERROR]", msg, err || "");
      }

      function normalizeAddress(raw) {
        if (!raw) return "";
        return String(raw)
          .replace(/ëŒ€í•œë¯¼êµ­|Republic of Korea/gi, "")
          .replace(/\s+/g, " ")
          .trim();
      }

      function isMobileWidth() {
        return window.innerWidth <= 768;
      }

      // ===== ì§€ë„ ì´ˆê¸°í™” =====
      function ensureMap() {
        if (map) return;
        map = new naver.maps.Map("map", {
          center: new naver.maps.LatLng(START_POINT_LAT, START_POINT_LNG),
          zoom: 11,
        });

        new naver.maps.Marker({
          position: new naver.maps.LatLng(START_POINT_LAT, START_POINT_LNG),
          map,
          title: "ì¶œë°œì§€",
        });
      }

      function fitMapToAll() {
        if (!map) return;
        const coords = households.filter((h) => h.lat != null && h.lng != null);
        if (!coords.length) return;
        const bounds = new naver.maps.LatLngBounds();
        coords.forEach((h) =>
          bounds.extend(new naver.maps.LatLng(h.lat, h.lng))
        );
        map.fitBounds(bounds);
      }

      // ===== ë§ˆì»¤ ì•„ì´ì½˜ (ë©”ëª¨ ìˆëŠ” ì§‘ì€ ì£¼í™©ìƒ‰) =====
      function makeMarkerIcon(h, index, isActive) {
        const mobile = isMobileWidth();
        const radius = mobile ? 18 : 14;
        const size = radius * 2 + 8;

        const baseColor = h.memo ? "#f97316" : "#2563eb"; // ë©”ëª¨ ìˆëŠ” ì§‘ = ì£¼í™©ìƒ‰
        const fillColor = isActive ? "#ffffff" : baseColor;
        const strokeColor = isActive ? baseColor : "#ffffff";
        const textColor = isActive ? baseColor : "#ffffff";

        const num = index != null ? String(index + 1) : "";

        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}">
  <defs>
    <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
      <feDropShadow dx="0" dy="1.2" stdDeviation="1.4" flood-color="rgba(15,23,42,0.45)" />
    </filter>
  </defs>
  <circle cx="${size / 2}" cy="${
          size / 2
        }" r="${radius}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="3" filter="url(#shadow)"/>
  <!-- í„°ì¹˜ì˜ì—­ í™•ëŒ€ìš© íˆ¬ëª…ì› -->
  <circle cx="${size / 2}" cy="${size / 2}" r="${
          radius + 6
        }" fill="transparent" />
  <text x="50%" y="50%" text-anchor="middle" dominant-baseline="central" font-size="${
    mobile ? 14 : 12
  }" font-weight="700" fill="${textColor}">${num}</text>
</svg>`;

        return {
          url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg),
          size: new naver.maps.Size(size, size),
          anchor: new naver.maps.Point(size / 2, size / 2),
        };
      }

      // ===== ë„¤ë¹„ê²Œì´ì…˜ ì—°ë™ =====
      function openNavSheetForHouse(h) {
        if (!h || h.lat == null || h.lng == null) {
          alert("ì¢Œí‘œê°€ ì—†ëŠ” ì£¼ì†Œì…ë‹ˆë‹¤.");
          return;
        }
        navTarget = h;
        const sub = document.getElementById("nav-sheet-dest");
        if (sub) {
          const addr = h.rawAddress || h.normAddress || "";
          const title = h.representName || "";
          if (addr && title) sub.textContent = `${title} Â· ${addr}`;
          else if (addr) sub.textContent = addr;
          else sub.textContent = `ìœ„ë„ ${h.lat}, ê²½ë„ ${h.lng}`;
        }
        document.getElementById("nav-sheet-overlay").classList.add("open");
        document.getElementById("nav-sheet").classList.add("open");
      }

      function closeNavSheet() {
        navTarget = null;
        document.getElementById("nav-sheet-overlay").classList.remove("open");
        document.getElementById("nav-sheet").classList.remove("open");
      }

      function openNavIfTarget(builder) {
        if (!navTarget || navTarget.lat == null || navTarget.lng == null) {
          alert("ëª©ì ì§€ ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        const url = builder(navTarget);
        if (url) {
          window.location.href = url;
        }
      }

      function buildNaverRouteUrl(h) {
        const dname = encodeURIComponent(
          h.representName || h.rawAddress || "ë°°ì†¡ì§€"
        );
        return (
          "nmap://route/car?" +
          "slat=" +
          START_POINT_LAT +
          "&slng=" +
          START_POINT_LNG +
          "&sname=" +
          encodeURIComponent("ì¶œë°œì§€") +
          "&dlat=" +
          h.lat +
          "&dlng=" +
          h.lng +
          "&dname=" +
          dname +
          "&appname=com.order.dispatch"
        );
      }

      function buildNaverPlaceUrl(h) {
        const name = encodeURIComponent(
          h.representName || h.rawAddress || "ë°°ì†¡ì§€"
        );
        return (
          "nmap://place?" +
          "lat=" +
          h.lat +
          "&lng=" +
          h.lng +
          "&name=" +
          name +
          "&appname=com.order.dispatch"
        );
      }

      function buildKakaoRouteUrl(h) {
        return (
          "kakaomap://route?" +
          "sp=" +
          START_POINT_LAT +
          "," +
          START_POINT_LNG +
          "&ep=" +
          h.lat +
          "," +
          h.lng +
          "&by=CAR"
        );
      }

      function buildTmapRouteUrl(h) {
        return (
          "tmap://route?" + "goalx=" + h.lng + "&goaly=" + h.lat + "&by=CAR"
        );
      }

      // ===== íŒŒì¼ ì²˜ë¦¬ & household ë¹Œë“œ =====
      async function handleFile(file) {
        try {
          logInfo("ì—‘ì…€ ì½ëŠ” ì¤‘...");
          const rows = await readXlsxFile(file);
          if (!rows || rows.length === 0) {
            logError("ì—‘ì…€ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }
          document.getElementById("fileName").textContent = file.name;

          // í—¤ë” ê°ì§€
          const firstRow = rows[0].map((c) =>
            c == null ? "" : String(c).trim()
          );
          const headerKeys = ["ì£¼ì†Œ", "address", "cbm", "ì „í™”", "phone"];
          const hasHeader = firstRow.some((cell) =>
            headerKeys.some((key) =>
              cell.toLowerCase().includes(key.toLowerCase())
            )
          );

          let dataRows;
          let headers;
          if (hasHeader) {
            headers = firstRow;
            dataRows = rows.slice(1);
          } else {
            headers = firstRow.map((_, i) => "COL" + (i + 1));
            dataRows = rows; // ì²« ì¤„ë„ ë°ì´í„°ë¡œ ì‚¬ìš©
          }

          // í—¤ë” ê¸°ë°˜ ì¸ë±ìŠ¤ ì°¾ê¸°
          function findIdx(names, fallback) {
            const lower = headers.map((h) => String(h).trim().toLowerCase());
            for (const n of names) {
              const idx = lower.indexOf(String(n).toLowerCase());
              if (idx !== -1) return idx;
            }
            return fallback;
          }

          const idxAddr = findIdx(["ì£¼ì†Œ", "address"], COL_INDEX_FALLBACK.addr);
          const idxPhone = findIdx(
            ["ì „í™”", "ì „í™”ë²ˆí˜¸", "phone", "tel"],
            COL_INDEX_FALLBACK.phone
          );
          const idxCBM = findIdx(["cbm"], COL_INDEX_FALLBACK.cbm);
          const idxOrder = findIdx(
            ["ì£¼ë¬¸ë²ˆí˜¸", "orderno", "order no"],
            COL_INDEX_FALLBACK.orderNo
          );
          const idxInvoice = findIdx(
            ["ìš´ì†¡ì¥ë²ˆí˜¸", "invoice", "ì†¡ì¥ë²ˆí˜¸"],
            COL_INDEX_FALLBACK.invoiceNo
          );
          const idxProduct = findIdx(
            ["ìƒí’ˆëª…", "product", "sku name"],
            COL_INDEX_FALLBACK.product
          );
          const idxVendor = findIdx(
            ["vendoritemid", "vendor item id"],
            COL_INDEX_FALLBACK.vendor
          );
          const idxMemo = findIdx(
            ["ë©”ëª¨", "ìš”ì²­ì‚¬í•­", "ìš”ì²­", "memo", "note"],
            COL_INDEX_FALLBACK.memoFixed
          );

          // ì£¼ì†Œ ë‹¨ìœ„ë¡œ ë¬¶ê¸°
          const mapByAddr = new Map();
          let totalParts = 0;
          let totalCBM = 0;

          for (let rIdx = 0; rIdx < dataRows.length; rIdx++) {
            const row = dataRows[rIdx];
            const addrRaw = row[idxAddr];
            const addrNorm = normalizeAddress(addrRaw);
            if (!addrNorm) continue;

            // CBM 0ì€ ì œì™¸
            let cbmVal = null;
            if (idxCBM != null && idxCBM < row.length) {
              const v = parseFloat(row[idxCBM]);
              if (!isNaN(v)) cbmVal = v;
            }
            if (cbmVal !== null && cbmVal <= 0) continue;

            const key = addrNorm;
            if (!mapByAddr.has(key)) {
              mapByAddr.set(key, {
                id: null,
                rawAddress: addrRaw || addrNorm,
                normAddress: addrNorm,
                rows: [],
                phone: null,
                orderNo: null,
                invoiceNo: null,
                representName: "",
                memo: null,
                lat: null,
                lng: null,
                cbmSum: 0,
              });
            }
            const h = mapByAddr.get(key);
            h.rows.push(row);

            if (!h.phone && idxPhone < row.length) {
              const ph = row[idxPhone];
              if (ph) h.phone = String(ph);
            }
            if (!h.orderNo && idxOrder < row.length) {
              const o = row[idxOrder];
              if (o) h.orderNo = String(o);
            }
            if (!h.invoiceNo && idxInvoice < row.length) {
              const inv = row[idxInvoice];
              if (inv) h.invoiceNo = String(inv);
            }
            if (idxProduct < row.length) {
              const p = row[idxProduct];
              if (p && !h.representName) h.representName = String(p);
            }
            if (!h.memo && idxMemo < row.length) {
              const m = row[idxMemo];
              if (m) h.memo = String(m).trim();
            }
            if (cbmVal !== null) {
              h.cbmSum += cbmVal;
              totalCBM += cbmVal;
            }
            totalParts++;
          }

          households = Array.from(mapByAddr.values());
          households.forEach((h, i) => (h.id = i));

          logInfo("ì§€ì˜¤ì½”ë”© ì¤‘...");
          await geocodeAllHouseholds();

          logInfo("ì§€ë„/ë¦¬ìŠ¤íŠ¸ ë Œë”ë§...");
          renderAll({ totalParts, totalCBM });
          logInfo("ì™„ë£Œ");
        } catch (e) {
          logError("ì—‘ì…€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜", e);
        }
      }

      function geocodeAddress(query) {
        return new Promise((resolve) => {
          naver.maps.Service.geocode({ query }, (status, response) => {
            if (status !== naver.maps.Service.Status.OK) {
              resolve(null);
            } else {
              resolve(response);
            }
          });
        });
      }

      async function geocodeAllHouseholds() {
        for (let i = 0; i < households.length; i++) {
          const h = households[i];
          try {
            const res = await geocodeAddress(
              h.normAddress || h.rawAddress || ""
            );
            if (
              res &&
              res.v2 &&
              res.v2.addresses &&
              res.v2.addresses.length > 0
            ) {
              const a = res.v2.addresses[0];
              const lat = parseFloat(a.y);
              const lng = parseFloat(a.x);
              if (!isNaN(lat) && !isNaN(lng)) {
                h.lat = lat;
                h.lng = lng;
              }
            }
          } catch (e) {
            // ignore
          }
          logInfo(`ì§€ì˜¤ì½”ë”©... (${i + 1}/${households.length})`);
        }
      }

      // ===== ë Œë” ì „ì²´ =====
      function renderAll(extra) {
        ensureMap();
        renderMarkers();
        renderList(extra);
        fitMapToAll();
      }

      // ===== ë§ˆì»¤ ë Œë”ë§ =====
      function renderMarkers() {
        markersById.forEach((m) => m.setMap(null));
        markersById.clear();

        households.forEach((h, idx) => {
          if (h.lat == null || h.lng == null) return;
          const marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(h.lat, h.lng),
            map,
            icon: makeMarkerIcon(h, idx, false),
            title: h.representName || h.rawAddress || "ë°°ì†¡ì§€",
          });

          naver.maps.Event.addListener(marker, "click", () => {
            focusHousehold(h.id, { fromMarker: true });
          });

          markersById.set(h.id, marker);
        });
      }

      function updateMarkerAppearance() {
        households.forEach((h, idx) => {
          const marker = markersById.get(h.id);
          if (!marker) return;
          const isActive = uiState.focusedHouseholdId === h.id;
          marker.setIcon(makeMarkerIcon(h, idx, isActive));
        });
      }

      // ===== ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ =====
      function renderList(extra) {
        const listEl = document.getElementById("list");
        listEl.innerHTML = "";

        // ìš”ì•½ ì •ë³´
        const totalHouses = households.length;
        const totalParts = extra ? extra.totalParts : 0;
        const totalCBM = extra ? extra.totalCBM : 0;
        document.getElementById(
          "summary-houses"
        ).textContent = `ê°€êµ¬ ${totalHouses}`;
        document.getElementById(
          "summary-parts"
        ).textContent = `í’ˆëª© ${totalParts}`;
        document.getElementById(
          "summary-cbm"
        ).textContent = `CBM ${totalCBM.toFixed(2)}`;

        households.forEach((h, idx) => {
          const card = document.createElement("div");
          card.className = "house-card";
          card.dataset.houseId = h.id;

          // ìƒë‹¨ ì •ë³´
          const topRow = document.createElement("div");
          topRow.className = "house-top-row";

          const leftWrap = document.createElement("div");
          const title = document.createElement("div");
          title.className = "house-main-title";
          title.textContent = h.representName || "(ìƒí’ˆëª… ì—†ìŒ)".concat("");

          const addr = document.createElement("div");
          addr.className = "house-addr";
          addr.textContent = h.rawAddress || h.normAddress || "";

          leftWrap.appendChild(title);
          leftWrap.appendChild(addr);

          const badge = document.createElement("div");
          badge.className = "house-main-badge";
          badge.textContent = `#${idx + 1} Â· í’ˆëª© ${h.rows.length}ê°œ`;

          topRow.appendChild(leftWrap);
          topRow.appendChild(badge);
          card.appendChild(topRow);

          // ì£¼ë¬¸/ìš´ì†¡ì¥ ë¼ì¸
          const subLine = document.createElement("div");
          subLine.className = "house-sub-line";
          const orderStr = h.orderNo ? `ì£¼ë¬¸ë²ˆí˜¸ ${h.orderNo}` : "";
          const invStr = h.invoiceNo ? ` / ìš´ì†¡ì¥ ${h.invoiceNo}` : "";
          subLine.textContent =
            orderStr || invStr ? orderStr + invStr : "ì£¼ë¬¸/ìš´ì†¡ì¥ ì •ë³´ ì—†ìŒ";
          card.appendChild(subLine);

          // ë©”ëª¨ (ìˆìœ¼ë©´ í‘œì‹œ)
          if (h.memo) {
            const memoEl = document.createElement("div");
            memoEl.className = "house-memo";
            memoEl.textContent = h.memo;
            card.appendChild(memoEl);
          }

          // ì•„ì´ì½˜ row
          const iconRow = document.createElement("div");
          iconRow.className = "icon-row";

          // ì „í™” ì•„ì´ì½˜
          const phoneBtn = document.createElement("button");
          phoneBtn.className = "icon-btn";
          phoneBtn.innerHTML = "<span>ğŸ“</span><span>ì „í™”</span>";
          if (!h.phone) {
            phoneBtn.classList.add("disabled");
          } else {
            phoneBtn.addEventListener("click", (ev) => {
              ev.stopPropagation();
              const tel = String(h.phone).replace(/[^\d+]/g, "");
              if (!tel) return;
              window.location.href = "tel:" + tel;
            });
          }
          iconRow.appendChild(phoneBtn);

          // ë„¤ë¹„ ì•„ì´ì½˜
          const navBtn = document.createElement("button");
          navBtn.className = "icon-btn primary";
          navBtn.innerHTML = "<span>ğŸ“</span><span>ë„¤ë¹„</span>";
          if (h.lat == null || h.lng == null) {
            navBtn.classList.add("disabled");
          } else {
            navBtn.addEventListener("click", (ev) => {
              ev.stopPropagation();
              openNavSheetForHouse(h);
            });
          }
          iconRow.appendChild(navBtn);

          // ìƒí’ˆ ë§í¬ ì•„ì´ì½˜ (vendorItemId ìˆëŠ” ê²½ìš°)
          const productBtn = document.createElement("button");
          productBtn.className = "icon-btn";
          productBtn.innerHTML = "<span>ğŸ›’</span><span>ìƒí’ˆ</span>";
          let vendorId = null;
          if (h.rows.length > 0 && h.rows[0].length > 0) {
            // ê°„ë‹¨íˆ ì²« í–‰ì—ì„œ vendor ì¶”ì¶œ
            const firstRow = h.rows[0];
            // vendor ì»¬ëŸ¼ ì¸ë±ìŠ¤ëŠ” ì•Œ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ìœ„ì—ì„œ idxVendor ë”°ë¡œ ê´€ë¦¬í•´ë„ ë¨
          }
          // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì—†ëŠ” ê²ƒìœ¼ë¡œ ì²˜ë¦¬ (ì›í•˜ë©´ vendorId ì—°ê²° ê°€ëŠ¥)
          productBtn.classList.add("disabled");
          iconRow.appendChild(productBtn);

          // ìƒì„¸ ì•„ì´ì½˜
          const detailBtn = document.createElement("button");
          detailBtn.className = "icon-btn";
          detailBtn.innerHTML = "<span>ğŸ“¦</span><span>ìƒì„¸</span>";
          iconRow.appendChild(detailBtn);

          card.appendChild(iconRow);

          // ìƒì„¸ íŒŒì¸  ì˜ì—­
          const partsWrap = document.createElement("div");
          partsWrap.className = "parts-list hidden";

          const partsTitle = document.createElement("div");
          partsTitle.className = "parts-list-title";
          partsTitle.textContent = "í’ˆëª© ìƒì„¸";
          partsWrap.appendChild(partsTitle);

          const ul = document.createElement("ul");
          h.rows.forEach((row) => {
            const li = document.createElement("li");
            li.textContent = row[COL_INDEX_FALLBACK.product] || "í’ˆëª©";
            ul.appendChild(li);
          });
          partsWrap.appendChild(ul);
          card.appendChild(partsWrap);

          detailBtn.addEventListener("click", (ev) => {
            ev.stopPropagation();
            partsWrap.classList.toggle("hidden");
          });

          // ì¹´ë“œ í´ë¦­ â†’ í¬ì»¤ìŠ¤ + ì§€ë„ ì´ë™
          card.addEventListener("click", () => {
            focusHousehold(h.id, { fromList: true });
          });

          listEl.appendChild(card);
        });

        updateCardActiveState();
      }

      function updateCardActiveState() {
        const cards = document.querySelectorAll(".house-card");
        cards.forEach((c) => {
          const id = Number(c.dataset.houseId);
          if (uiState.focusedHouseholdId === id) c.classList.add("active");
          else c.classList.remove("active");
        });
      }

      // ===== í¬ì»¤ìŠ¤ & ë™ê¸°í™” =====
      function focusHousehold(houseId, options) {
        const opt = options || {};
        const h = households.find((x) => x.id === houseId);
        if (!h) return;

        uiState.focusedHouseholdId = houseId;
        updateCardActiveState();
        updateMarkerAppearance();

        if (h.lat != null && h.lng != null && map) {
          const pos = new naver.maps.LatLng(h.lat, h.lng);
          map.setCenter(pos);
          if (isMobileWidth()) {
            map.setZoom(15);
          }
        }

        // ë¦¬ìŠ¤íŠ¸ì—ì„œ í•´ë‹¹ ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
        const listEl = document.getElementById("list");
        const card = listEl.querySelector(
          `.house-card[data-house-id="${houseId}"]`
        );
        if (card && opt.fromMarker) {
          const top = card.offsetTop - 10;
          listEl.scrollTo({ top, behavior: "smooth" });
        }
      }

      // ===== ì´ˆê¸°í™” =====
      window.addEventListener("load", () => {
        ensureMap();

        const fileInput = document.getElementById("fileInput");
        fileInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (file) {
            handleFile(file);
          }
        });

        // ë„¤ë¹„ ì‹œíŠ¸ ë°”ê¹¥ í´ë¦­/ë‹«ê¸°
        const ov = document.getElementById("nav-sheet-overlay");
        ov.addEventListener("click", closeNavSheet);
        const btnClose = document.getElementById("btn-nav-close");
        btnClose.addEventListener("click", closeNavSheet);

        document
          .getElementById("btn-nav-naver-route")
          .addEventListener("click", () => openNavIfTarget(buildNaverRouteUrl));
        document
          .getElementById("btn-nav-naver-place")
          .addEventListener("click", () => openNavIfTarget(buildNaverPlaceUrl));
        document
          .getElementById("btn-nav-kakao")
          .addEventListener("click", () => openNavIfTarget(buildKakaoRouteUrl));
        document
          .getElementById("btn-nav-tmap")
          .addEventListener("click", () => openNavIfTarget(buildTmapRouteUrl));

        logInfo("ì—‘ì…€ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.");
      });
    </script>
  </body>
</html>
