<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>ê¸°ì‚¬ ì „ìš© ë°°ì†¡ ì§€ë„ (Coupang Flex Style)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- NAVER ì§€ë„ -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=ms2yp98bvf&submodules=geocoder"></script>
    <!-- Excel -->
    <script src="https://unpkg.com/read-excel-file@5.7.1/bundle/read-excel-file.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f3f4f6;
        color: #111827;
        display: flex;
        flex-direction: column;
      }

      header {
        background: #111827;
        color: #f9fafb;
        padding: 8px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
      }
      header .left {
        display: flex;
        gap: 6px;
        align-items: center;
        font-weight: 700;
      }
      header .file {
        font-size: 11px;
        color: #e5e7eb;
        max-width: 55%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: right;
      }

      /* âœ… ì „ì²´ ì˜ì—­: ìœ„=ì§€ë„, ì•„ë˜=ë¦¬ìŠ¤íŠ¸ 2í–‰ ê·¸ë¦¬ë“œ */
      #app {
        flex: 1;
        display: grid;
        grid-template-rows: 52% 48%; /* ê¸°ë³¸ ë¹„ìœ¨ */
        min-height: 0;
      }

      /* âœ… ê·¸ë¦¬ë“œ ì•ˆì—ì„œ ê° í–‰ì´ ìê¸° ì¹¸ì„ ê½‰ ì±„ìš°ë„ë¡ */
      #mapWrap {
        min-height: 0;
      }

      #map {
        width: 100%;
        height: 100%;
      }

      #listWrap {
        background: #ffffff;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -4px 12px rgba(15, 23, 42, 0.25);
        display: flex;
        flex-direction: column;
        min-height: 0;
        max-height: none;
      }

      #handle {
        height: 18px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: ns-resize;
        touch-action: none;
      }
      #handle::after {
        content: "";
        width: 40px;
        height: 4px;
        background: #d1d5db;
        border-radius: 999px;
      }

      #listHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 12px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 12px;
        color: #4b5563;
      }

      #summary span {
        background: #f3f4f6;
        padding: 2px 6px;
        border-radius: 999px;
        margin-right: 6px;
      }

      #list {
        flex: 1;
        overflow: auto;
        background: #f9fafb;
        padding: 6px 10px;
      }

      .card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 10px;
        font-size: 12px;
        margin-bottom: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        cursor: pointer;
      }
      .card.active {
        border-color: #2563eb;
        box-shadow: 0 0 0 1px #2563eb;
      }

      .rowTop {
        display: flex;
        justify-content: space-between;
        gap: 8px;
      }
      .title {
        font-weight: 700;
        font-size: 13px;
      }
      .badge {
        font-size: 11px;
        background: #eff6ff;
        color: #1d4ed8;
        padding: 2px 6px;
        border-radius: 999px;
        white-space: nowrap;
      }
      .addr {
        font-size: 11px;
        color: #374151;
        margin-top: 2px;
      }
      .sub {
        font-size: 11px;
        color: #4b5563;
        margin-top: 2px;
      }
      .memo {
        margin-top: 4px;
        padding: 6px;
        background: #fef2f2;
        color: #b91c1c;
        border-radius: 6px;
        font-size: 11px;
      }

      .icons {
        display: flex;
        gap: 14px; /* ì•„ì´ì½˜ í„°ì¹˜ ì˜ì—­ ë„“ê²Œ */
        flex-wrap: wrap;
        margin-top: 6px;
      }

      .btn {
        border: 0;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 11px;
        background: #f3f4f6;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .btn.primary {
        background: #2563eb;
        color: #ffffff;
      }
      .btn.disabled {
        opacity: 0.4;
        cursor: default;
      }

      .parts {
        margin-top: 6px;
        border-top: 1px dashed #e5e7eb;
        padding-top: 4px;
        font-size: 11px;
      }
      .parts.hidden {
        display: none;
      }

      /* âœ… ìš´ì†¡ì¥/ì£¼ë¬¸ë²ˆí˜¸ + ë 4ìë¦¬ ê°•ì¡° */
      .codes {
        margin-bottom: 4px;
      }
      .code-line {
        display: flex;
        align-items: baseline;
        gap: 4px;
        cursor: pointer;
        margin-bottom: 2px;
      }
      .code-label {
        font-size: 11px;
        color: #6b7280;
        min-width: 60px;
      }
      .code-main {
        font-size: 11px;
        color: #111827;
      }
      .code-last4 {
        font-size: 14px;
        font-weight: 700;
        color: #111827;
      }

      footer {
        border-top: 1px solid #e5e7eb;
        background: #f9fafb;
        padding: 6px 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
      }

      label.upload {
        background: #2563eb;
        color: #ffffff;
        border-radius: 999px;
        padding: 4px 10px;
        cursor: pointer;
      }

      #file {
        display: none;
      }

      #log {
        color: #6b7280;
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-left: 8px;
      }

      /* ë„¤ë¹„ ì„ íƒ ì‹œíŠ¸ */
      #overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: none;
        z-index: 30;
      }
      #overlay.show {
        display: block;
      }

      #sheet {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: #ffffff;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.3);
        padding: 12px;
        transform: translateY(100%);
        transition: transform 0.2s;
        z-index: 40;
      }
      #sheet.show {
        transform: translateY(0);
      }
      #sheet button {
        margin-bottom: 6px;
        padding: 8px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        width: 100%;
        text-align: left;
        font-size: 13px;
      }
      #sheet button.primary {
        background: #2563eb;
        color: #ffffff;
        border-color: #2563eb;
      }

      /* í† ìŠ¤íŠ¸ */
      #toast {
        position: fixed;
        left: 50%;
        bottom: 80px;
        transform: translateX(-50%);
        background: rgba(17, 24, 39, 0.9);
        color: #ffffff;
        padding: 8px 14px;
        border-radius: 999px;
        font-size: 11px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
        z-index: 50;
      }
      #toast.show {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="left">ğŸšš ê¸°ì‚¬ ì „ìš© ë°°ì†¡</div>
      <div id="fileName" class="file">ì—‘ì…€ ì„ íƒ</div>
    </header>

    <div id="app">
      <div id="mapWrap">
        <div id="map"></div>
      </div>
      <div id="listWrap">
        <div id="handle"></div>
        <div id="listHeader">
          <div id="summary">
            <span id="sumHome">ê°€êµ¬ 0</span>
            <span id="sumItem">í’ˆëª© 0</span>
            <span id="sumCBM">CBM 0</span>
          </div>
        </div>
        <div id="list"></div>
      </div>
    </div>

    <footer>
      <div style="display: flex; align-items: center">
        <label class="upload" for="file">ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</label>
        <input id="file" type="file" accept=".xlsx,.xls" />
        <span id="log"></span>
      </div>
    </footer>

    <div id="overlay"></div>
    <div id="sheet">
      <div id="sheetTitle" style="font-weight: 700; margin-bottom: 6px">
        ë„¤ë¹„ê²Œì´ì…˜ ì„ íƒ
      </div>
      <button id="navN" class="primary">ğŸš— ë„¤ì´ë²„ ê¸¸ì°¾ê¸°</button>
      <button id="navNP">ğŸ“ ë„¤ì´ë²„ ì¥ì†Œ í˜ì´ì§€</button>
      <button id="navK">ğŸŸ¡ ì¹´ì¹´ì˜¤ë§µ</button>
      <button id="navT">ğŸ”µ í‹°ë§µ</button>
      <button onclick="closeSheet()">ë‹«ê¸°</button>
    </div>

    <div id="toast"></div>

    <script>
      const START_LAT = 37.158135;
      const START_LNG = 127.103159;

      let map = null;
      let homes = [];
      let markers = new Map();
      let focusId = null;
      let navTarget = null;

      const GEO_CACHE_KEY = "flex_geocode_cache_v1";
      const GEO_CACHE_TTL = 3 * 24 * 60 * 60 * 1000; // 3ì¼
      let geoCache = {};

      const logEl = document.getElementById("log");
      const listEl = document.getElementById("list");
      const sumHomeEl = document.getElementById("sumHome");
      const sumItemEl = document.getElementById("sumItem");
      const sumCBMEl = document.getElementById("sumCBM");
      const overlayEl = document.getElementById("overlay");
      const sheetEl = document.getElementById("sheet");
      const navNBtn = document.getElementById("navN");
      const navNPBtn = document.getElementById("navNP");
      const navKBtn = document.getElementById("navK");
      const navTBtn = document.getElementById("navT");
      const fileNameEl = document.getElementById("fileName");
      const appEl = document.getElementById("app");
      const listWrapEl = document.getElementById("listWrap");
      const handleEl = document.getElementById("handle");
      const toastEl = document.getElementById("toast");

      function setLog(msg) {
        if (logEl) logEl.textContent = msg || "";
      }

      function initMap() {
        if (map) return;
        map = new naver.maps.Map("map", {
          center: new naver.maps.LatLng(START_LAT, START_LNG),
          zoom: 11,
        });
        new naver.maps.Marker({
          position: new naver.maps.LatLng(START_LAT, START_LNG),
          map,
          title: "ì¶œë°œì§€",
        });
      }

      function markerIcon(h, index, active) {
        const r = 20;
        const size = r * 2 + 8;
        const isMemo = !!h.memo;

        const baseColor = isMemo ? "#f97316" : "#2563eb";
        const fill = active ? "#ffffff" : baseColor;
        const stroke = active ? baseColor : "#ffffff";
        const textColor = active ? baseColor : "#ffffff";

        const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}">
  <circle cx="${size / 2}" cy="${
          size / 2
        }" r="${r}" fill="${fill}" stroke="${stroke}" stroke-width="3" />
  <circle cx="${size / 2}" cy="${size / 2}" r="${r + 6}" fill="transparent" />
  <text x="50%" y="50%" dominant-baseline="central" text-anchor="middle"
        fill="${textColor}" font-size="13" font-weight="700">${index + 1}</text>
</svg>`;
        return {
          url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg),
          size: new naver.maps.Size(size, size),
          anchor: new naver.maps.Point(size / 2, size / 2),
        };
      }

      function render() {
        initMap();
        setTimeout(resizeMapToWrap, 0);
        markers.forEach((m) => m.setMap(null));
        markers.clear();

        homes.forEach((h, index) => {
          if (h.lat == null || h.lng == null) return;
          const m = new naver.maps.Marker({
            position: new naver.maps.LatLng(h.lat, h.lng),
            map,
            icon: markerIcon(h, index, false),
          });
          naver.maps.Event.addListener(m, "click", () =>
            focusHome(h.id, "marker")
          );
          markers.set(h.id, m);
        });

        fitAll();
        renderList();
      }

      function fitAll() {
        if (!map) return;
        const bounds = new naver.maps.LatLngBounds();
        let hasPoint = false;
        homes.forEach((h) => {
          if (h.lat != null && h.lng != null) {
            bounds.extend(new naver.maps.LatLng(h.lat, h.lng));
            hasPoint = true;
          }
        });
        if (hasPoint) {
          map.fitBounds(bounds);
        }
      }

      function renderList() {
        listEl.innerHTML = "";
        let totalItems = 0;
        let totalCBM = 0;

        homes.forEach((h, index) => {
          totalItems += h.rows.length;
          totalCBM += h.cbm || 0;

          const card = document.createElement("div");
          card.className = "card";
          card.dataset.id = h.id;
          if (h.id === focusId) card.classList.add("active");

          const title = h.name || "(ìƒí’ˆëª… ì—†ìŒ)";
          const orderText = h.order ? `ì£¼ë¬¸ ${h.order}` : "";
          const invoiceText = h.invoice ? `ìš´ì†¡ì¥ ${h.invoice}` : "";
          const orderLine = `${invoiceText}${
            invoiceText && orderText ? " / " : ""
          }${orderText}`;

          const phoneVal = h.phone == null ? "" : String(h.phone);
          const invoiceVal = h.invoice == null ? "" : String(h.invoice);
          const orderVal = h.order == null ? "" : String(h.order);
          const linkVal = h.link == null ? "" : String(h.link);

          const phoneEsc = phoneVal.replace(/'/g, "\\'");
          const invoiceEsc = invoiceVal.replace(/'/g, "\\'");
          const orderEsc = orderVal.replace(/'/g, "\\'");
          const linkEsc = linkVal.replace(/'/g, "\\'");

          const invoiceMain =
            invoiceVal && invoiceVal.length > 4 ? invoiceVal.slice(0, -4) : "";
          const invoiceLast4 = invoiceVal ? invoiceVal.slice(-4) : "";
          const orderMain =
            orderVal && orderVal.length > 4 ? orderVal.slice(0, -4) : "";
          const orderLast4 = orderVal ? orderVal.slice(-4) : "";

          card.innerHTML = `
        <div class="rowTop">
          <div>
            <div class="title">${title}</div>
            <div class="addr">${h.addr}</div>
          </div>
          <div class="badge">#${index + 1} Â· ${h.rows.length}ê°œ</div>
        </div>
        <div class="sub">${orderLine}</div>
        ${h.memo ? `<div class="memo">${h.memo}</div>` : ""}
        <div class="icons">
          <button class="btn ${!phoneVal ? "disabled" : ""}"
            onclick="event.stopPropagation(); ${
              phoneVal ? `callPhone('${phoneEsc}')` : ""
            }">ğŸ“ ì „í™”</button>
          <button class="btn primary"
            onclick="event.stopPropagation(); openNavSheet(${
              h.id
            });">ğŸ“ ë„¤ë¹„</button>
          <button class="btn"
            onclick="event.stopPropagation(); openProduct('${linkEsc}');">ğŸ›’ ìƒí’ˆ</button>
          <button class="btn"
            onclick="event.stopPropagation(); copyCodes('${invoiceEsc}','${orderEsc}');">ğŸ“‹ ë³µì‚¬</button>
          <button class="btn"
            onclick="event.stopPropagation(); toggleParts(this);">ğŸ“¦ ìƒì„¸</button>
        </div>
        <div class="parts hidden">
          ${
            invoiceVal || orderVal
              ? `<div class="codes">
              ${
                invoiceVal
                  ? `<div class="code-line" onclick="event.stopPropagation(); copySingle('invoice','${invoiceEsc}')">
                      <span class="code-label">ìš´ì†¡ì¥ë²ˆí˜¸</span>
                      <span class="code-main">${invoiceMain}</span>
                      <span class="code-last4">${invoiceLast4}</span>
                    </div>`
                  : ""
              }
              ${
                orderVal
                  ? `<div class="code-line" onclick="event.stopPropagation(); copySingle('order','${orderEsc}')">
                      <span class="code-label">ì£¼ë¬¸ë²ˆí˜¸</span>
                      <span class="code-main">${orderMain}</span>
                      <span class="code-last4">${orderLast4}</span>
                    </div>`
                  : ""
              }
            </div>`
              : ""
          }
          <b>í’ˆëª© ìƒì„¸</b>
          <ul>${h.rows.map((r) => `<li>${r}</li>`).join("")}</ul>
        </div>
      `;

          card.addEventListener("click", () => focusHome(h.id, "list"));

          listEl.appendChild(card);
        });

        sumHomeEl.textContent = `ê°€êµ¬ ${homes.length}`;
        sumItemEl.textContent = `í’ˆëª© ${totalItems}`;
        sumCBMEl.textContent = `CBM ${totalCBM.toFixed(2)}`;
      }

      function focusHome(id, from) {
        focusId = id;
        homes.forEach((h, index) => {
          const m = markers.get(h.id);
          if (m) {
            const active = h.id === id;
            m.setIcon(markerIcon(h, index, active));
          }
        });

        const h = homes.find((x) => x.id === id);
        if (h && h.lat != null && h.lng != null && map) {
          map.setCenter(new naver.maps.LatLng(h.lat, h.lng));
          map.setZoom(15);
        }

        const cards = listEl.querySelectorAll(".card");
        cards.forEach((card) => {
          const isActive = String(card.dataset.id) === String(id);
          card.classList.toggle("active", isActive);
          if (from === "marker" && isActive) {
            card.scrollIntoView({ behavior: "smooth", block: "nearest" });
          }
        });
      }

      function toggleParts(btn) {
        const parts = btn.parentElement.nextElementSibling;
        if (parts) parts.classList.toggle("hidden");
      }

      function callPhone(phone) {
        if (!phone) return;
        const cleaned = String(phone).replace(/[^\d+]/g, "");
        if (!cleaned) return;
        location.href = "tel:" + cleaned;
      }

      function openProduct(url) {
        if (!url) return;
        window.open(url, "_blank");
      }

      let toastTimer = null;
      function showToast(msg) {
        if (!toastEl) return;
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          toastEl.classList.remove("show");
        }, 2000);
      }

      function copyCodes(invoice, orderNo) {
        const text = `ìš´ì†¡ì¥ë²ˆí˜¸  ${invoice}\nì£¼ë¬¸ë²ˆí˜¸  ${orderNo}`;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(text)
            .then(() => showToast("ìš´ì†¡ì¥/ì£¼ë¬¸ë²ˆí˜¸ ë³µì‚¬ë¨"))
            .catch(() => showToast("ë³µì‚¬ ì‹¤íŒ¨"));
        } else {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          try {
            document.execCommand("copy");
            showToast("ìš´ì†¡ì¥/ì£¼ë¬¸ë²ˆí˜¸ ë³µì‚¬ë¨");
          } catch (e) {
            showToast("ë³µì‚¬ ì‹¤íŒ¨");
          }
          document.body.removeChild(ta);
        }
      }

      function copySingle(type, value) {
        if (!value) return;
        const text =
          type === "invoice" ? `ìš´ì†¡ì¥ë²ˆí˜¸  ${value}` : `ì£¼ë¬¸ë²ˆí˜¸  ${value}`;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(text)
            .then(() =>
              showToast(
                type === "invoice" ? "ìš´ì†¡ì¥ë²ˆí˜¸ ë³µì‚¬ë¨" : "ì£¼ë¬¸ë²ˆí˜¸ ë³µì‚¬ë¨"
              )
            )
            .catch(() => showToast("ë³µì‚¬ ì‹¤íŒ¨"));
        } else {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          try {
            document.execCommand("copy");
            showToast(
              type === "invoice" ? "ìš´ì†¡ì¥ë²ˆí˜¸ ë³µì‚¬ë¨" : "ì£¼ë¬¸ë²ˆí˜¸ ë³µì‚¬ë¨"
            );
          } catch (e) {
            showToast("ë³µì‚¬ ì‹¤íŒ¨");
          }
          document.body.removeChild(ta);
        }
      }

      function openNavSheet(id) {
        navTarget = homes.find((h) => h.id === id) || null;
        if (!navTarget || navTarget.lat == null || navTarget.lng == null) {
          alert("ì¢Œí‘œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨");
          return;
        }
        overlayEl.classList.add("show");
        sheetEl.classList.add("show");
      }

      function closeSheet() {
        overlayEl.classList.remove("show");
        sheetEl.classList.remove("show");
      }

      overlayEl.addEventListener("click", closeSheet);

      function openNavUrl(url) {
        if (!navTarget) return;
        location.href = url;
      }

      navNBtn.addEventListener("click", () => {
        if (!navTarget) return;
        const url =
          `nmap://route/car?slat=${START_LAT}&slng=${START_LNG}` +
          `&sname=${encodeURIComponent("ì¶œë°œì§€")}` +
          `&dlat=${navTarget.lat}&dlng=${navTarget.lng}` +
          `&dname=${encodeURIComponent(navTarget.addr)}`;
        openNavUrl(url);
      });

      navNPBtn.addEventListener("click", () => {
        if (!navTarget) return;
        const url =
          `nmap://place?lat=${navTarget.lat}&lng=${navTarget.lng}` +
          `&name=${encodeURIComponent(navTarget.addr)}`;
        openNavUrl(url);
      });

      navKBtn.addEventListener("click", () => {
        if (!navTarget) return;
        const url =
          `kakaomap://route?ep=${navTarget.lat},${navTarget.lng}` + `&by=CAR`;
        openNavUrl(url);
      });

      navTBtn.addEventListener("click", () => {
        if (!navTarget) return;
        const url = `tmap://route?goalx=${navTarget.lng}&goaly=${navTarget.lat}`;
        openNavUrl(url);
      });

      window.closeSheet = closeSheet;
      window.callPhone = callPhone;
      window.openProduct = openProduct;
      window.copyCodes = copyCodes;
      window.copySingle = copySingle;
      window.toggleParts = toggleParts;
      window.openNavSheet = openNavSheet;

      /* ì§€ì˜¤ìºì‹œ ë¡œë“œ/ì €ì¥ + ë§Œë£Œ ì •ë¦¬ */
      function loadGeoCache() {
        try {
          const raw = localStorage.getItem(GEO_CACHE_KEY);
          geoCache = raw ? JSON.parse(raw) : {};
        } catch (e) {
          geoCache = {};
        }
        const now = Date.now();
        let changed = false;
        for (const addr in geoCache) {
          const item = geoCache[addr];
          if (!item || !item.ts || now - item.ts > GEO_CACHE_TTL) {
            delete geoCache[addr];
            changed = true;
          }
        }
        if (changed) saveGeoCache();
      }

      function saveGeoCache() {
        try {
          localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(geoCache));
        } catch (e) {
          console.warn("geo cache save failed", e);
        }
      }

      /* ë¦¬ìŠ¤íŠ¸ ë†’ì´ ë“œë˜ê·¸: grid-template-rows ì¡°ì ˆ */
      let isDragging = false;
      let dragStartY = 0;
      let dragStartRatio = 48; // ë¦¬ìŠ¤íŠ¸ ë¹„ìœ¨ %

      function startDrag(clientY) {
        isDragging = true;
        dragStartY = clientY;

        const appRect = appEl.getBoundingClientRect();
        const listRect = listWrapEl.getBoundingClientRect();
        if (appRect.height > 0) {
          dragStartRatio = (listRect.height / appRect.height) * 100;
        } else {
          dragStartRatio = 48;
        }
      }

      function resizeMapToWrap() {
        if (!map) return;
        const wrap = document.getElementById("mapWrap");
        if (!wrap) return;

        const w = wrap.clientWidth;
        const h = wrap.clientHeight;

        // í•µì‹¬: ë„¤ì´ë²„ ì§€ë„ëŠ” DOM í¬ê¸° ë³€í™”ë¥¼ ìë™ ë°˜ì˜ ì•ˆ í•¨
        map.setSize(new naver.maps.Size(w, h));

        // ë¦¬ë Œë” íŠ¸ë¦¬ê±°(ì•ˆì „ì¥ì¹˜)
        naver.maps.Event.trigger(map, "resize");
      }

      function moveDrag(clientY) {
        if (!isDragging) return;
        const appRect = appEl.getBoundingClientRect();
        if (appRect.height <= 0) return;

        const deltaY = clientY - dragStartY;
        const ratioDelta = (deltaY / appRect.height) * 100;
        let newRatio = dragStartRatio + ratioDelta * -1; // ì•„ë˜ë¡œ ë‚´ë¦¬ë©´ ë¦¬ìŠ¤íŠ¸ ì»¤ì§

        if (newRatio < 25) newRatio = 25;
        if (newRatio > 80) newRatio = 80;

        const mapRatio = 100 - newRatio;
        appEl.style.gridTemplateRows = `${mapRatio}% ${newRatio}%`;
        requestAnimationFrame(resizeMapToWrap);
      }

      function endDrag() {
        isDragging = false;
      }

      function onMouseMove(e) {
        moveDrag(e.clientY);
      }
      function onMouseUp() {
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);
        endDrag();
      }

      handleEl.addEventListener("mousedown", (e) => {
        e.preventDefault();
        startDrag(e.clientY);
        document.addEventListener("mousemove", onMouseMove);
        document.addEventListener("mouseup", onMouseUp);
      });

      handleEl.addEventListener(
        "touchstart",
        (e) => {
          if (!e.touches || !e.touches[0]) return;
          startDrag(e.touches[0].clientY);
        },
        { passive: true }
      );
      handleEl.addEventListener(
        "touchmove",
        (e) => {
          if (!e.touches || !e.touches[0]) return;
          moveDrag(e.touches[0].clientY);
        },
        { passive: true }
      );
      handleEl.addEventListener(
        "touchend",
        () => {
          endDrag();
        },
        { passive: true }
      );

      /* ì—‘ì…€ ë¡œë”© */
      document.getElementById("file").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        fileNameEl.textContent = file.name;
        setLog("ì—‘ì…€ ì½ëŠ” ì¤‘...");

        try {
          const rows = await readXlsxFile(file);
          if (!rows || rows.length < 1) {
            setLog("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          // í—¤ë” ì¡´ì¬ ì—¬ë¶€ ìë™ íŒë‹¨ (ì£¼ì†Œ ì—´ ê¸°ì¤€)
          let dataRows = [];
          if (rows.length === 1) {
            dataRows = rows;
          } else {
            const addr0 = rows[0][13];
            if (
              addr0 &&
              typeof addr0 === "string" &&
              /[0-9]/.test(addr0) &&
              (addr0.includes("ë™") ||
                addr0.includes("ë¡œ") ||
                addr0.includes("ê¸¸"))
            ) {
              dataRows = rows;
            } else {
              dataRows = rows.slice(1);
            }
          }

          const mapByAddr = new Map();
          let idSeq = 0;

          dataRows.forEach((r) => {
            const addr = r[13]; // ì£¼ì†Œ (14ë²ˆì§¸ ì—´)
            if (!addr) return;

            const phone = r[11]; // ì „í™”ë²ˆí˜¸ (12ë²ˆì§¸ ì—´)
            const orderNo = r[4]; // ì£¼ë¬¸ë²ˆí˜¸ (5ë²ˆì§¸ ì—´)
            const invoice = r[5]; // ìš´ì†¡ì¥ë²ˆí˜¸ (6ë²ˆì§¸ ì—´)
            const skuName = r[9]; // SKUëª… (10ë²ˆì§¸ ì—´, ëŒ€í‘œ ìƒí’ˆëª…)
            const cbm = parseFloat(r[10]) || 0; // 11ë²ˆì§¸ ì—´
            const memo = r[18]; // ë©”ëª¨(19ë²ˆì§¸ ì—´)
            const itemId = r[6]; // 7ë²ˆì§¸ ì—´
            const productLink = itemId
              ? `https://www.coupang.com/vp/products/5606756170?vendorItemId=${itemId}`
              : "";

            if (!mapByAddr.has(addr)) {
              mapByAddr.set(addr, {
                id: idSeq++,
                addr,
                rows: [],
                phone: phone || "",
                order: orderNo || "",
                invoice: invoice || "",
                name: skuName || "",
                memo: memo || "",
                cbm,
                lat: null,
                lng: null,
                link: productLink,
              });
            }
            const h = mapByAddr.get(addr);
            h.rows.push(skuName || "í’ˆëª©");
            h.cbm += cbm;
          });

          homes = Array.from(mapByAddr.values());

          setLog("ì§€ì˜¤ì½”ë”© ì¤‘...");
          loadGeoCache();

          for (const h of homes) {
            const key = (h.addr || "").trim();
            if (!key) continue;

            const cached = geoCache[key];
            if (
              cached &&
              typeof cached.lat === "number" &&
              typeof cached.lng === "number"
            ) {
              h.lat = cached.lat;
              h.lng = cached.lng;
              continue;
            }

            try {
              const geoRes = await new Promise((resolve) => {
                naver.maps.Service.geocode(
                  { query: key },
                  (status, response) => {
                    if (status !== naver.maps.Service.Status.OK) {
                      resolve(null);
                    } else {
                      resolve(response);
                    }
                  }
                );
              });
              if (
                geoRes &&
                geoRes.v2 &&
                geoRes.v2.addresses &&
                geoRes.v2.addresses.length > 0
              ) {
                const a = geoRes.v2.addresses[0];
                const lat = parseFloat(a.y);
                const lng = parseFloat(a.x);
                if (!isNaN(lat) && !isNaN(lng)) {
                  h.lat = lat;
                  h.lng = lng;
                  geoCache[key] = {
                    lat,
                    lng,
                    ts: Date.now(),
                  };
                }
              }
            } catch (err) {
              console.error("ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨", err);
            }
          }

          saveGeoCache();
          render();
          setLog("ì™„ë£Œ");
        } catch (err) {
          console.error(err);
          setLog("ì—‘ì…€ ì²˜ë¦¬ ì˜¤ë¥˜");
        }
      });
    </script>
  </body>
</html>
