<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>ê¸°ì‚¬ìš© ë°°ë‹¬ ë¦¬ìŠ¤íŠ¸ (ëª¨ë°”ì¼ ì „ìš©)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- NAVER ì§€ë„ -->
    <script
      type="text/javascript"
      src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=ms2yp98bvf&submodules=geocoder"
    ></script>

    <!-- Excel ì½ê¸° -->
    <script src="https://unpkg.com/read-excel-file@5.7.1/bundle/read-excel-file.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #0f172a;
        color: #e5e7eb;
        display: flex;
        flex-direction: column;
      }

      header {
        height: 52px;
        padding: 0 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #111827;
        border-bottom: 1px solid #1f2937;
      }
      header .title {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      header .title-main {
        font-size: 15px;
        font-weight: 700;
      }
      header .title-sub {
        font-size: 11px;
        color: #9ca3af;
      }
      header .file-chip {
        font-size: 11px;
        color: #9ca3af;
        max-width: 45vw;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: right;
      }

      #container {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      /* ìƒë‹¨: ì§€ë„ */
      #map-wrapper {
        flex: 0 0 46vh;
        min-height: 42vh;
        background: #020617;
        border-bottom: 1px solid #1f2937;
      }
      #map {
        width: 100%;
        height: 100%;
      }

      /* í•˜ë‹¨: ë¦¬ìŠ¤íŠ¸ */
      #list-wrapper {
        flex: 1;
        min-height: 0;
        background: #020617;
        display: flex;
        flex-direction: column;
      }

      #list-header {
        padding: 8px 14px 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: #9ca3af;
      }
      #summary-text {
        font-size: 12px;
      }
      #reload-btn {
        border: 0;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 11px;
        background: #1f2937;
        color: #e5e7eb;
      }

      #mobile-list {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        padding: 4px 10px 10px;
      }

      .stop-card {
        background: #020617;
        border-radius: 14px;
        border: 1px solid #1f2937;
        padding: 10px 12px;
        margin-bottom: 8px;
        display: grid;
        gap: 6px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6);
        cursor: pointer;
      }
      .stop-card.active {
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px #3b82f6, 0 8px 18px rgba(37, 99, 235, 0.35);
      }
      .stop-top-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        font-size: 11px;
        color: #9ca3af;
      }
      .stop-index-pill {
        padding: 2px 8px;
        border-radius: 999px;
        background: #0b1120;
        border: 1px solid #1f2937;
        font-weight: 600;
        color: #e5e7eb;
      }
      .stop-distance {
        font-size: 11px;
      }
      .stop-addr {
        font-size: 13px;
        font-weight: 600;
        color: #e5e7eb;
        line-height: 1.4;
      }
      .stop-main {
        font-size: 12px;
        color: #cbd5f5;
      }
      .stop-sub {
        font-size: 11px;
        color: #9ca3af;
      }

      .icon-row {
        margin-top: 6px;
        display: flex;
        gap: 10px;
      }
      .round-icon-btn {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        border: 0;
        background: #020617;
        border: 1px solid #1f2937;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #e5e7eb;
        cursor: pointer;
      }
      .round-icon-btn:active {
        background: #111827;
      }

      .stop-meta-row {
        margin-top: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
        color: #9ca3af;
      }

      .detail-block {
        margin-top: 6px;
        padding-top: 4px;
        border-top: 1px solid #1f2937;
        font-size: 11px;
        color: #e5e7eb;
      }
      .detail-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2px;
      }
      .detail-title {
        font-weight: 600;
        font-size: 11px;
      }
      .detail-toggle {
        font-size: 11px;
        color: #3b82f6;
      }
      .detail-list {
        margin: 0;
        padding-left: 18px;
      }
      .detail-list li {
        margin: 1px 0;
      }

      footer {
        height: 42px;
        border-top: 1px solid #1f2937;
        background: #020617;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 12px;
        font-size: 11px;
        color: #6b7280;
      }
      #log {
        max-width: 55vw;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      input[type="file"] {
        display: none;
      }
      label.upload-btn {
        border-radius: 999px;
        background: #3b82f6;
        color: #fff;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
      }

      @media (min-width: 769px) {
        body {
          max-width: 520px;
          margin: 0 auto;
          border-left: 1px solid #1f2937;
          border-right: 1px solid #1f2937;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="title">
        <span class="title-main">ì˜¤ëŠ˜ ë°°ì†¡</span>
        <span class="title-sub">ì—‘ì…€ ë¶ˆëŸ¬ì™€ì„œ ì‹œì‘í•˜ì„¸ìš”</span>
      </div>
      <div class="file-chip" id="file-name">íŒŒì¼ ì—†ìŒ</div>
    </header>

    <div id="container">
      <div id="map-wrapper">
        <div id="map"></div>
      </div>
      <div id="list-wrapper">
        <div id="list-header">
          <span id="summary-text">ì´ 0ê°€êµ¬ Â· í’ˆëª© 0ê°œ Â· CBM 0</span>
          <button id="reload-btn" type="button">ì¬ë¡œë“œ</button>
        </div>
        <div id="mobile-list"></div>
      </div>
    </div>

    <footer>
      <div id="log">ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
      <div>
        <label class="upload-btn" for="fileInput">ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</label>
        <input id="fileInput" type="file" accept=".xlsx,.xls" />
      </div>
    </footer>

    <script>
      // ===== ê¸°ë³¸ ìƒìˆ˜ & ìƒíƒœ =====
      const START_POINT_LAT = 37.158135;
      const START_POINT_LNG = 127.103159;
      const CBM_PRECISION = 3;

      let map = null;
      let households = [];
      let markers = new Map();
      let focusedId = null;

      const colConfig = {
        idxAddress: 13,
        idxCBM: 10,
        idxPhone: 11,
        idxVendor: 6,
        idxVIName: 7,
        idxSKUName: 9,
        idxVINumber: 5,
        idxOrderNo: 4,
        idxWaybill: 5,
      };

      function logInfo(msg) {
        console.log("[INFO]", msg);
        const el = document.getElementById("log");
        if (el) el.textContent = msg;
      }

      function logError(msg, err) {
        console.error("[ERROR]", msg, err || "");
        const el = document.getElementById("log");
        if (el) el.textContent = "âš  " + msg;
      }

      window.addEventListener("error", (e) => {
        logError("ì „ì—­ ì˜¤ë¥˜: " + e.message);
      });
      window.addEventListener("unhandledrejection", (e) => {
        logError(
          "ë¹„ë™ê¸° ì˜¤ë¥˜: " +
            (e.reason && e.reason.message ? e.reason.message : e.reason)
        );
      });

      function normalizeAddress(raw) {
        if (!raw) return "";
        return String(raw)
          .replace(/ëŒ€í•œë¯¼êµ­|Republic of Korea/gi, "")
          .replace(/\s+/g, " ")
          .replace(/[(),]/g, "")
          .trim();
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function haversineKm(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      function formatTelHref(phone) {
        if (!phone) return "";
        return "tel:" + String(phone).replace(/[^\d+]/g, "");
      }

      function makeNavUrl(h) {
        if (!h) return "";
        if (h.lat != null && h.lng != null) {
          return (
            "https://www.google.com/maps/dir/?api=1&origin=" +
            START_POINT_LAT +
            "," +
            START_POINT_LNG +
            "&destination=" +
            h.lat +
            "," +
            h.lng
          );
        }
        const q = encodeURIComponent(h.normAddress || h.rawAddress || "");
        return "https://www.google.com/maps/dir/?api=1&destination=" + q;
      }

      function makeCoupangUrl(vendorId) {
        if (!vendorId) return "https://www.coupang.com/";
        return (
          "https://www.coupang.com/vp/products/8239520807?vendorItemId=" +
          encodeURIComponent(String(vendorId))
        );
      }

      function ensureMap() {
        if (map) return;
        map = new naver.maps.Map("map", {
          center: new naver.maps.LatLng(START_POINT_LAT, START_POINT_LNG),
          zoom: 11,
        });
        new naver.maps.Marker({
          position: new naver.maps.LatLng(START_POINT_LAT, START_POINT_LNG),
          map,
          title: "ì¶œë°œì§€",
        });
      }

      async function handleFile(file) {
        try {
          logInfo("ì—‘ì…€ ì½ëŠ” ì¤‘...");
          const rows = await readXlsxFile(file);
          if (!rows || rows.length === 0) {
            logError("ì—‘ì…€ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const headers = rows[0].map((c) =>
            c == null ? "" : String(c).trim()
          );
          const bodyRows = rows.slice(1).map((cells, idx) => ({
            rowId: idx,
            cells: cells.map((c) => (c == null ? "" : c)),
          }));

          // í—¤ë” ê°ì§€ (ì£¼ì†Œ/ì „í™”/CBM ë¹„ìŠ·í•œ ë‹¨ì–´ í¬í•¨ë˜ë©´ í—¤ë”ë¡œ íŒë‹¨)
          const headerKeys = ["ì£¼ì†Œ", "address", "cbm", "ì „í™”", "phone"];
          const hasHeader = headers.some((cell) =>
            headerKeys.some((key) =>
              String(cell).toLowerCase().includes(key.toLowerCase())
            )
          );

          let dataRows;
          if (hasHeader) {
            dataRows = bodyRows;
          } else {
            dataRows = rows.map((cells, idx) => ({
              rowId: idx,
              cells: cells.map((c) => (c == null ? "" : c)),
            }));
          }

          // ì§‘ ë‹¨ìœ„ë¡œ ë¬¶ê¸°
          logInfo("ì§‘(ê°€êµ¬) ë‹¨ìœ„ë¡œ ë³€í™˜ ì¤‘...");
          households = buildHouseholds(dataRows);

          if (!households.length) {
            logError("ìœ íš¨í•œ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          // CBM 0ì¸ ì§‘ ì œê±°
          households = households.filter((h) => h.cbmSum > 0);

          // ì§€ì˜¤ì½”ë”©
          logInfo("ì£¼ì†Œ ì¢Œí‘œ ë³€í™˜(ì§€ì˜¤ì½”ë”©) ì¤‘...");
          await geocodeAllHouseholds();

          // ê±°ë¦¬ ê³„ì‚° & ìˆœì„œ ì •ë ¬
          households.forEach((h) => {
            if (h.lat != null && h.lng != null) {
              h.distanceKm = haversineKm(
                START_POINT_LAT,
                START_POINT_LNG,
                h.lat,
                h.lng
              );
            } else {
              h.distanceKm = null;
            }
          });

          households.sort((a, b) => {
            const da = a.distanceKm ?? 9999;
            const db = b.distanceKm ?? 9999;
            return da - db;
          });

          // ì¸ë±ìŠ¤ ë¶€ì—¬
          households.forEach((h, idx) => {
            h.displayIndex = idx + 1;
          });

          ensureMap();
          renderMarkers();
          renderMobileList();
          updateSummary();

          logInfo("ì™„ë£Œ");
        } catch (e) {
          logError("ì—‘ì…€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜", e);
        }
      }

      function buildHouseholds(rows) {
        const mapByAddr = new Map();
        const idxAddress = colConfig.idxAddress;
        const idxCBM = colConfig.idxCBM;
        const idxPhone = colConfig.idxPhone;
        const idxVendor = colConfig.idxVendor;
        const idxVIName = colConfig.idxVIName;
        const idxSKUName = colConfig.idxSKUName;
        const idxOrderNo = colConfig.idxOrderNo;
        const idxWaybill = colConfig.idxWaybill;

        for (const row of rows) {
          const cells = row.cells;
          const rawAddr = cells[idxAddress];
          const normAddr = normalizeAddress(rawAddr);
          if (!normAddr) continue;

          if (!mapByAddr.has(normAddr)) {
            mapByAddr.set(normAddr, {
              id: null,
              rawAddress: rawAddr,
              normAddress: normAddr,
              rows: [],
              sets: [],
              cbmSum: 0,
              phone: null,
              orderNo: null,
              waybill: null,
              lat: null,
              lng: null,
              distanceKm: null,
            });
          }
          const h = mapByAddr.get(normAddr);
          h.rows.push(row);

          if (idxCBM >= 0 && idxCBM < cells.length) {
            const v = parseFloat(cells[idxCBM]);
            if (!isNaN(v)) h.cbmSum += v;
          }
          if (!h.phone && idxPhone >= 0 && idxPhone < cells.length) {
            const ph = cells[idxPhone];
            if (ph) h.phone = String(ph);
          }
          if (!h.orderNo && idxOrderNo >= 0 && idxOrderNo < cells.length) {
            const on = cells[idxOrderNo];
            if (on) h.orderNo = String(on);
          }
          if (!h.waybill && idxWaybill >= 0 && idxWaybill < cells.length) {
            const wb = cells[idxWaybill];
            if (wb) h.waybill = String(wb);
          }
        }

        // ì„¸íŠ¸(ìƒí’ˆ) ë¬¶ê¸°
        let idSeq = 1;
        const list = [];
        for (const [, h] of mapByAddr) {
          h.id = idSeq++;

          const setMap = new Map();
          for (const row of h.rows) {
            const cells = row.cells;
            const viName = idxVIName >= 0 ? cells[idxVIName] : "";
            const skuName = idxSKUName >= 0 ? cells[idxSKUName] : "";
            const key =
              (viName && "VI:" + viName) ||
              (skuName && "SKU:" + skuName) ||
              "ROW:" + row.rowId;

            if (!setMap.has(key)) {
              setMap.set(key, {
                key,
                viName: viName || "",
                skuName: skuName || "",
                rows: [],
                vendorId:
                  idxVendor >= 0 && idxVendor < cells.length
                    ? cells[idxVendor]
                    : null,
              });
            }
            const s = setMap.get(key);
            s.rows.push(row);
          }

          const sets = [];
          for (const [, s] of setMap) {
            const repName = s.viName || s.skuName || "(í’ˆëª©)";
            sets.push({
              key: s.key,
              representName: String(repName),
              rowCount: s.rows.length,
              vendorId: s.vendorId || null,
            });
          }
          h.sets = sets;
          h.totalSets = sets.length;
          h.totalParts = h.rows.length;

          if (!h.totalParts || h.cbmSum <= 0) continue;
          list.push(h);
        }
        return list;
      }

      function geocodeAddress(query) {
        return new Promise((resolve) => {
          naver.maps.Service.geocode({ query }, (status, response) => {
            if (status !== naver.maps.Service.Status.OK) {
              resolve(null);
            } else {
              resolve(response);
            }
          });
        });
      }

      async function geocodeAllHouseholds() {
        const total = households.length;
        let done = 0;
        for (const h of households) {
          try {
            const q = h.normAddress || h.rawAddress;
            if (!q) continue;
            const r = await geocodeAddress(q);
            if (
              r &&
              r.v2 &&
              r.v2.addresses &&
              r.v2.addresses.length > 0
            ) {
              const a = r.v2.addresses[0];
              const lat = parseFloat(a.y);
              const lng = parseFloat(a.x);
              if (!isNaN(lat) && !isNaN(lng)) {
                h.lat = lat;
                h.lng = lng;
              }
            }
          } catch (e) {
            // ë¬´ì‹œ
          } finally {
            done++;
            logInfo(`ì§€ì˜¤ì½”ë”© ì¤‘... (${done}/${total})`);
          }
        }
      }

      function renderMarkers() {
        ensureMap();
        markers.forEach((mk) => mk.setMap(null));
        markers.clear();

        households.forEach((h) => {
          if (h.lat == null || h.lng == null) return;
          const mk = new naver.maps.Marker({
            position: new naver.maps.LatLng(h.lat, h.lng),
            map,
            title: h.normAddress,
          });
          naver.maps.Event.addListener(mk, "click", () => {
            focusStop(h.id, { from: "marker" });
          });
          markers.set(h.id, mk);
        });

        // fit bounds
        const coords = households.filter((h) => h.lat != null && h.lng != null);
        if (coords.length > 0) {
          const bounds = new naver.maps.LatLngBounds();
          coords.forEach((h) =>
            bounds.extend(new naver.maps.LatLng(h.lat, h.lng))
          );
          map.fitBounds(bounds);
        }
      }

      function focusStop(id, options) {
        const h = households.find((x) => x.id === id);
        if (!h) return;
        focusedId = id;

        // ì§€ë„ ì´ë™
        ensureMap();
        if (h.lat != null && h.lng != null) {
          const latlng = new naver.maps.LatLng(h.lat, h.lng);
          map.panTo(latlng);
        }

        // ë¦¬ìŠ¤íŠ¸ ê°•ì¡° & ìŠ¤í¬ë¡¤
        const list = document.getElementById("mobile-list");
        if (list) {
          const cards = list.querySelectorAll(".stop-card");
          cards.forEach((c) => c.classList.remove("active"));
          const card = list.querySelector(`[data-id="${id}"]`);
          if (card) {
            card.classList.add("active");
            card.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }
      }

      function updateSummary() {
        const el = document.getElementById("summary-text");
        if (!el) return;
        const totalHouse = households.length;
        const totalParts = households.reduce(
          (s, h) => s + (h.totalParts || 0),
          0
        );
        const totalCbm = households
          .reduce((s, h) => s + (h.cbmSum || 0), 0)
          .toFixed(CBM_PRECISION);
        el.textContent = `ì´ ${totalHouse}ê°€êµ¬ Â· í’ˆëª© ${totalParts}ê°œ Â· CBM ${totalCbm}`;
      }

      function renderMobileList() {
        const list = document.getElementById("mobile-list");
        if (!list) return;
        list.innerHTML = "";

        households.forEach((h) => {
          const card = document.createElement("div");
          card.className = "stop-card";
          card.dataset.id = h.id;

          if (focusedId === h.id) {
            card.classList.add("active");
          }

          // ìƒë‹¨ ì¸ë±ìŠ¤ & ê±°ë¦¬
          const topRow = document.createElement("div");
          topRow.className = "stop-top-row";
          const idxPill = document.createElement("div");
          idxPill.className = "stop-index-pill";
          idxPill.textContent = `#${h.displayIndex || h.id}`;
          topRow.appendChild(idxPill);

          const dist = document.createElement("div");
          dist.className = "stop-distance";
          if (h.distanceKm != null) {
            dist.textContent = h.distanceKm.toFixed(1) + "km";
          }
          topRow.appendChild(dist);
          card.appendChild(topRow);

          // ì£¼ì†Œ
          const addr = document.createElement("div");
          addr.className = "stop-addr";
          addr.textContent = h.normAddress || h.rawAddress || "(ì£¼ì†Œ ì—†ìŒ)";
          card.appendChild(addr);

          // ëŒ€í‘œ ìƒí’ˆ
          const main = document.createElement("div");
          main.className = "stop-main";
          if (h.sets && h.sets.length > 0) {
            const first = h.sets[0];
            if (h.sets.length === 1) {
              main.textContent = first.representName;
            } else {
              main.textContent =
                first.representName + ` ì™¸ ${h.sets.length - 1}ì„¸íŠ¸`;
            }
          } else {
            main.textContent = "(ìƒí’ˆ ì •ë³´ ì—†ìŒ)";
          }
          card.appendChild(main);

          // ì£¼ë¬¸ë²ˆí˜¸ / ìš´ì†¡ì¥
          const sub = document.createElement("div");
          sub.className = "stop-sub";
          const parts = [];
          if (h.orderNo) parts.push("ì£¼ë¬¸ " + h.orderNo);
          if (h.waybill) parts.push("ìš´ì†¡ì¥ " + h.waybill);
          parts.push(
            `ì„¸íŠ¸ ${h.totalSets || 0} Â· ë¶€í’ˆ ${h.totalParts || 0} Â· CBM ${h.cbmSum.toFixed(
              CBM_PRECISION
            )}`
          );
          sub.textContent = parts.join(" / ");
          card.appendChild(sub);

          // ì•„ì´ì½˜ ì¤„
          const iconRow = document.createElement("div");
          iconRow.className = "icon-row";

          // ì „í™”
          const phoneBtn = document.createElement("button");
          phoneBtn.type = "button";
          phoneBtn.className = "round-icon-btn";
          phoneBtn.textContent = "ğŸ“";
          phoneBtn.onclick = (ev) => {
            ev.stopPropagation();
            if (h.phone) {
              window.location.href = formatTelHref(h.phone);
            }
          };
          iconRow.appendChild(phoneBtn);

          // ê¸¸ì°¾ê¸°
          const navBtn = document.createElement("button");
          navBtn.type = "button";
          navBtn.className = "round-icon-btn";
          navBtn.textContent = "ğŸš—";
          navBtn.onclick = (ev) => {
            ev.stopPropagation();
            const url = makeNavUrl(h);
            if (url) window.open(url, "_blank");
          };
          iconRow.appendChild(navBtn);

          // ìƒí’ˆ ë§í¬ (ì²« ì„¸íŠ¸ ê¸°ì¤€)
          const prodBtn = document.createElement("button");
          prodBtn.type = "button";
          prodBtn.className = "round-icon-btn";
          prodBtn.textContent = "ğŸ›’";
          prodBtn.onclick = (ev) => {
            ev.stopPropagation();
            let vendorId = null;
            if (h.sets && h.sets.length > 0) {
              vendorId = h.sets[0].vendorId;
            }
            const url = makeCoupangUrl(vendorId);
            window.open(url, "_blank");
          };
          iconRow.appendChild(prodBtn);

          card.appendChild(iconRow);

          // í•˜ë‹¨ ë©”íƒ€ (ë„ì‹œ/ê±°ë¦¬)
          const metaRow = document.createElement("div");
          metaRow.className = "stop-meta-row";
          const leftMeta = document.createElement("span");
          leftMeta.textContent = "";
          metaRow.appendChild(leftMeta);
          const rightMeta = document.createElement("span");
          if (h.distanceKm != null) {
            rightMeta.textContent = "ì•½ " + h.distanceKm.toFixed(1) + "km";
          }
          metaRow.appendChild(rightMeta);
          card.appendChild(metaRow);

          // ìƒì„¸ í’ˆëª©
          const detail = document.createElement("div");
          detail.className = "detail-block";
          const titleRow = document.createElement("div");
          titleRow.className = "detail-title-row";
          const dtTitle = document.createElement("span");
          dtTitle.className = "detail-title";
          dtTitle.textContent = "ìƒì„¸ í’ˆëª©";
          titleRow.appendChild(dtTitle);
          const toggle = document.createElement("span");
          toggle.className = "detail-toggle";
          toggle.textContent = "í¼ì¹˜ê¸°";
          titleRow.appendChild(toggle);
          detail.appendChild(titleRow);

          const ul = document.createElement("ul");
          ul.className = "detail-list";
          ul.style.display = "none";
          if (h.sets && h.sets.length > 0) {
            h.sets.forEach((s) => {
              const li = document.createElement("li");
              li.textContent = `${s.representName} (ë¶€í’ˆ ${s.rowCount}ê°œ)`;
              ul.appendChild(li);
            });
          } else {
            const li = document.createElement("li");
            li.textContent = "(ì„¸ë¶€ í’ˆëª© ì—†ìŒ)";
            ul.appendChild(li);
          }
          detail.appendChild(ul);

          toggle.onclick = (ev) => {
            ev.stopPropagation();
            const isOpen = ul.style.display !== "none";
            ul.style.display = isOpen ? "none" : "block";
            toggle.textContent = isOpen ? "í¼ì¹˜ê¸°" : "ì ‘ê¸°";
          };

          card.appendChild(detail);

          card.onclick = () => {
            focusStop(h.id, { from: "list" });
          };

          list.appendChild(card);
        });
      }

      // ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
      document.getElementById("fileInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById("file-name").textContent = file.name;
        document.querySelector(".title-sub").textContent = "ë°°ì†¡ ì •ë³´ ë¡œë”© ì¤‘...";
        handleFile(file).then(() => {
          document.querySelector(".title-sub").textContent = "ë°°ì†¡ ë¦¬ìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ";
        });
      });

      document.getElementById("reload-btn").addEventListener("click", () => {
        const input = document.getElementById("fileInput");
        if (!input.files || !input.files[0]) {
          logInfo("ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
          return;
        }
        handleFile(input.files[0]);
      });

      // ì´ˆê¸° ì§€ë„ë§Œ ì¤€ë¹„
      ensureMap();
    </script>
  </body>
</html>
