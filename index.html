<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>주소 → NAVER 지도 & 엑셀 그룹 묶기</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- ✅ NAVER 지도 API (신규 ncpKeyId 방식) -->
    <script
      type="text/javascript"
      src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=ms2yp98bvf&submodules=geocoder"
    ></script>

    <!-- ✅ SheetJS (엑셀 파싱용) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: "Pretendard", system-ui, -apple-system, sans-serif;
        background: #f3f4f8;
      }
      body {
        display: flex;
        flex-direction: column;
      }

      #app {
        flex: 1;
        display: flex;
        min-height: 0;
      }

      /* ===== 상단 바 ===== */
      #headerBar {
        background: #ffffff;
        height: 46px;
        border-bottom: 1px solid #d4d9f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 14px;
      }
      #headerBar .title {
        font-weight: 700;
        font-size: 15px;
      }
      #toggleSidebarBtn {
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
      }

      /* ===== 사이드 ===== */
      #sidebar {
        width: 430px;
        background: #f9faff;
        border-right: 1px solid #d4d9f0;
        display: flex;
        flex-direction: column;
        transition: transform 0.25s ease;
      }
      #sidebar.hidden {
        transform: translateX(-100%);
      }
      #sidebarInner {
        flex: 1;
        padding: 10px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      #settingsPanel {
        background: #ffffff;
        padding: 10px;
        border-radius: 12px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        margin-bottom: 8px;
      }

      button {
        cursor: pointer;
      }
      button.primary {
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 12px;
      }

      #map {
        flex: 1;
      }

      /* ===== 그룹 카드 ===== */
      .groupCard {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7f5;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.04);
        margin-bottom: 8px;
        overflow: hidden;
      }
      .groupHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
        font-size: 14px;
        font-weight: 700;
        padding: 8px 10px;
        color: #111827;
        cursor: pointer;
      }
      .groupHeader:hover {
        background: #eef2ff;
      }
      .groupContent {
        padding: 6px 10px 10px;
        display: block;
      }
      .groupCard.collapsed .groupContent {
        display: none;
      }

      .cbmBadge {
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
      }
      .cbm-safe {
        background: #dcfce7;
        color: #166534;
      }
      .cbm-normal {
        background: #fef9c3;
        color: #854d0e;
      }
      .cbm-danger {
        background: #fee2e2;
        color: #b91c1c;
      }

      .householdItem {
        border-top: 1px dashed #e5e7eb;
        padding-top: 6px;
        margin-top: 6px;
        cursor: grab;
      }
      .householdItem.dragging {
        opacity: 0.5;
        cursor: grabbing;
      }

      select.groupSelect {
        border-radius: 999px;
        border: 1px solid #cbd5f5;
        background: #f9fafb;
        font-size: 11px;
        padding: 2px 6px;
      }

      @media (max-width: 900px) {
        #app {
          flex-direction: column;
        }
        #sidebar {
          width: 100%;
          border-bottom: 1px solid #d4d9f0;
        }
        #sidebar.hidden {
          transform: translateY(-100%);
        }
      }
    </style>
  </head>
  <body>
    <div id="headerBar">
      <div class="title">주소 → 지도 & 그룹 묶기</div>
      <button id="toggleSidebarBtn">지도만 보기</button>
    </div>

    <div id="app">
      <div id="sidebar">
        <div id="sidebarInner">
          <div id="settingsPanel">
            <input type="file" id="excelInput" />
            <button class="primary" id="geocodeBtn">주소 지오코딩</button>
            <button class="primary" id="groupBtn">그룹 묶기</button>
          </div>
          <div id="groupListWrapper"></div>
        </div>
      </div>

      <div id="map"></div>
    </div>

    <script>
      const START_POINT = new naver.maps.LatLng(37.158135, 127.103159);
      const groupColors = [
        "#2563eb",
        "#16a34a",
        "#f97316",
        "#ec4899",
        "#8b5cf6",
        "#06b6d4",
        "#facc15",
        "#0ea5e9",
        "#10b981",
        "#fb7185",
      ];

      let map, infoWindow;
      let markers = [];
      let points = [];
      let groups = [];

      function initMap() {
        map = new naver.maps.Map("map", {
          center: START_POINT,
          zoom: 9,
        });
        infoWindow = new naver.maps.InfoWindow();
        naver.maps.Event.addListener(map, "click", () => infoWindow.close());
      }
      naver.maps.onJSContentLoaded = initMap;

      function cbmStatusTag(cbm) {
        if (cbm < 7)
          return { text: `${cbm.toFixed(1)} CBM (안전)`, cls: "cbm-safe" };
        if (cbm <= 8)
          return { text: `${cbm.toFixed(1)} CBM (적정)`, cls: "cbm-normal" };
        return { text: `${cbm.toFixed(1)} CBM (위험)`, cls: "cbm-danger" };
      }

      // 그룹 UI 업데이트
      function updateGroupUI() {
        const wrapper = document.getElementById("groupListWrapper");
        let html = "";
        groups.forEach((g, i) => {
          const totalCbm = g.points.reduce((s, p) => s + p.cbm, 0);
          const cbmInfo = cbmStatusTag(totalCbm);
          const color = groupColors[i % groupColors.length];

          html += `
            <div class="groupCard" data-group="${i}">
              <div class="groupHeader" style="background:${color}15;">
                <span>그룹 ${i + 1} ▾ (${g.points.length} 가구)</span>
                <div class="cbmBadge ${cbmInfo.cls}">${cbmInfo.text}</div>
              </div>
              <div class="groupContent">
                ${g.points
                  .map(
                    (p, idx) => `
                    <div class="householdItem" data-idx="${idx}">
                      <div>${p.addr}</div>
                      <select class="groupSelect" data-idx="${idx}">
                        ${groups
                          .map(
                            (_, gi) =>
                              `<option value="${gi}" ${
                                i === gi ? "selected" : ""
                              }>그룹 ${gi + 1}</option>`
                          )
                          .join("")}
                      </select>
                    </div>`
                  )
                  .join("")}
              </div>
            </div>
          `;
        });
        wrapper.innerHTML = html;
        attachGroupEvents();
      }

      // 접기/펼치기 + 그룹 변경
      function attachGroupEvents() {
        document.querySelectorAll(".groupHeader").forEach((h) => {
          h.addEventListener("click", () => {
            const card = h.closest(".groupCard");
            card.classList.toggle("collapsed");
          });
        });
      }

      // 지도 마커 갱신
      function renderMarkers() {
        markers.forEach((m) => m.setMap(null));
        markers = [];
        const bounds = new naver.maps.LatLngBounds();
        groups.forEach((g, i) => {
          g.points.forEach((p) => {
            const color = groupColors[i % groupColors.length];
            const pos = new naver.maps.LatLng(p.lat, p.lng);
            const marker = new naver.maps.Marker({
              position: pos,
              map,
              icon: {
                content: `<div style="width:24px;height:24px;border-radius:50%;background:${color};color:#fff;font-weight:600;font-size:12px;display:flex;align-items:center;justify-content:center;">${
                  i + 1
                }</div>`,
                anchor: new naver.maps.Point(12, 12),
              },
            });
            bounds.extend(pos);
            naver.maps.Event.addListener(marker, "click", () => {
              const totalCbm = g.points.reduce((s, p) => s + p.cbm, 0);
              const totalItems = g.points.length;
              const cbmInfo = cbmStatusTag(totalCbm);
              infoWindow.setContent(`
                <div style="padding:6px;font-size:12px;">
                  <b>그룹 ${i + 1}</b><br/>
                  가구수: ${totalItems}<br/>
                  CBM 합계: <span class="${cbmInfo.cls}">${cbmInfo.text}</span>
                </div>
              `);
              infoWindow.open(map, marker);
            });
            markers.push(marker);
          });
        });
        if (!bounds.isEmpty()) map.fitBounds(bounds);
      }

      // === 임시 테스트용 가짜 데이터 ===
      points = [
        { addr: "경기 평택시 지산로 128", lat: 37.045, lng: 127.06, cbm: 7.3 },
        { addr: "경기 평택시 송탄로 170", lat: 37.07, lng: 127.08, cbm: 8.2 },
        { addr: "경기 평택시 청원로 1290", lat: 37.05, lng: 127.05, cbm: 6.8 },
        { addr: "경기 평택시 송탄2로 44", lat: 37.06, lng: 127.07, cbm: 7.9 },
      ];
      groups = [{ points: points.slice(0, 2) }, { points: points.slice(2) }];
      updateGroupUI();
      renderMarkers();
    </script>
  </body>
</html>
